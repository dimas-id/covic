In December 2019, the first cases of infection with a novel coronavirus, SARS-CoV-2, were diagnosed in Wuhan, China. Due to international travel and human-to-human transmission, the virus spread rapidly inside and outside of China. Currently, there is no effective antiviral treatment for coronavirus disease 2019 (COVID-19); therefore, research efforts are focused on the rapid development of vaccines and antiviral drugs. The SARS-CoV-2 main protease constitutes one of the most attractive antiviral drug targets. To address this emerging problem, we have synthesized a combinatorial library of fluorogenic substrates with glutamine in the P1 position. We used it to determine the substrate preferences of the SARS-CoV and SARS-CoV-2 main proteases, using natural and a large panel of unnatural amino acids. On the basis of these findings, we designed and synthesized an inhibitor and two activity-based probes, for one of which we determined the crystal structure of its complex with the SARS-CoV-2 Mpro. Using this approach we visualized SARS-CoV-2 active Mpro within nasopharyngeal epithelial cells of a patient with active COVID-19 infection. The results of our work provide a structural framework for the design of inhibitors as antiviral agents or diagnostic tests.
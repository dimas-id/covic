We propose a mathematical model based on probability theory to optimize COVID-19 testing by a multi-step batch testing approach with variable batch sizes. This model and simulation tool dramatically increase the efficiency and efficacy of the tests in a large population at a low cost. The proposed method combines statistical modeling with numerical methods to solve nonlinear equations and obtain optimal batch sizes at each step of tests, with the flexibility to incorporate geographic and demographic information. We also conducted a Monte Carlo simulation study to verify this theory. Our simulation results show that our method reduces the false negative rate by 80%. Our method substantially improves the false positive rate and positive predictive value as well. The proposed method will be particularly useful for the prevention of a second wave of the coronavirus outbreaks, and more generally for the early stages of future pandemics. The proposed work will have broader impacts on medical testing for contagious diseases in general.